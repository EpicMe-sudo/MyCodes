/*
    This file is part of the ChipWhisperer Example Targets
    Copyright (C) 2012-2017 NewAE Technology Inc.

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

#include "hal.h"
#include "api.h"
#include "poly.h"
#include "poly_mul.h"
#include "rng.h"
#include "SABER_indcpa.h"
#include "fips202.h"
#include "verify.h"
#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include "simpleserial.h"

#define h1 (1 << (SABER_EQ - SABER_EP - 1))
#define h2 ((1 << (SABER_EP - 2)) - (1 << (SABER_EP - SABER_ET - 1)) + (1 << (SABER_EQ - SABER_EP - 1)))

uint16_t a[256] = {
0x1be7, 0x10b5, 0x1e95, 0x4e7, 0x228, 0x614, 0x744, 0x33b, 0x1684, 0x301, 0x1a58, 0x1ced, 0x18d2, 0x56c, 0x836, 0x432, 0xa1c, 0x100a, 0x269, 0x1788, 0x15b8, 0xc66, 0x4b8, 0xf7b, 0x543, 0x7b2, 0xed2, 0xb5, 0x1ebe, 0xcda, 0x2b7, 0xf7d, 0x874, 0x1d72, 0x86, 0xecf, 0x175f, 0x19d4, 0x19ad, 0x351, 0xc56, 0xcba, 0x1b15, 0xc22, 0x1a0e, 0xc01, 0x1d05, 0x116, 0x1e1c, 0xbd1, 0xa2f, 0x660, 0x5fa, 0x5bf, 0x42, 0xb57, 0x1610, 0x523, 0x9b2, 0x1d6d, 0x960, 0x1c37, 0x1afc, 0x1738, 0x1859, 0x179f, 0x57b, 0x142a, 0x1a3e, 0x951, 0x910, 0x199e, 0x1835, 0x2eb, 0x8ec, 0x5a5, 0x145b, 0xab2, 0x1717, 0x351, 0x109a, 0xbd, 0x12ba, 0x1a6f, 0x117c, 0xf1, 0x28d, 0x1278, 0x6c1, 0xca3, 0x1ae2, 0x14ce, 0x1a5, 0x1dce, 0x1191, 0x4f3, 0x654, 0x1429, 0x1daf, 0x59, 0x86a, 0x152a, 0x7ed, 0xbf5, 0x1668, 0x172a, 0x48c, 0x17c8, 0x1f76, 0x401, 0x10f, 0x190b, 0xed9, 0x18b3, 0x6e7, 0x13b2, 0x12d7, 0x189a, 0x12da, 0x12b7, 0x952, 0x2aa, 0xd3e, 0x1660, 0x17a5, 0x6d5, 0x1543, 0xede, 0x1323, 0x1551, 0x10f0, 0x356, 0x195, 0x1b5b, 0xee8, 0x4e5, 0x926, 0x167, 0x24a, 0x7f1, 0xa44, 0x1509, 0x1d12, 0x1946, 0x1d2b, 0x1bbb, 0x846, 0x1f74, 0x92f, 0xd42, 0x1f2e, 0x16b0, 0x16d0, 0x32d, 0x1a22, 0x9a6, 0x196, 0xffe, 0x1772, 0x52f, 0xd6f, 0x17d0, 0x3b5, 0x1278, 0x364, 0xbb9, 0x17cf, 0x1d73, 0x1686, 0x91d, 0x1888, 0xcc5, 0x12c, 0xc1f, 0x1042, 0xb87, 0xec0, 0x1fe9, 0x5cb, 0x1d24, 0x12ab, 0xad9, 0x152c, 0x1fe5, 0xf4c, 0x2bb, 0x56c, 0x1821, 0x1b5, 0x480, 0xfb2, 0xfe4, 0x1452, 0x1ebc, 0x1f66, 0x15ec, 0x1077, 0x107c, 0xfae, 0x629, 0x1cc5, 0x1f2e, 0x2fa, 0x18bd, 0x13a1, 0x9bd, 0x928, 0x455, 0x2cc, 0xded, 0x681, 0xb95, 0x1ae8, 0xf04, 0x1d6c, 0xc92, 0xd91, 0x1f46, 0x2d8, 0xce1, 0x1de1, 0x586, 0x17ee, 0x1386, 0x3c5, 0xe5b, 0x110a, 0x1d44, 0x4f, 0x18cf, 0x163d, 0x600, 0x1742, 0x11b3, 0x1cdf, 0x7a4, 0xc71, 0xe8f, 0xabc, 0xc6e, 0xc1c, 0x4de, 0x138, 0x91c, 0x1110, 0xdb5, 0x365, 0x196c, 0x1065, 0x16f8, 0x1f9d, 0x1547, 0x2f3, 0xc7e, 0x19c3, 0x15f5
};

uint16_t re[256] = {
0xffff, 0xffff, 0xfffe, 0x3, 0x0, 0x0, 0xfffd, 0x1, 0x2, 0x0, 0x2, 0x0, 0x0, 0x2, 0x2, 0xffff, 0x1, 0xffff, 0xffff, 0x0, 0x0, 0xffff, 0x1, 0x2, 0xffff, 0xfffe, 0x2, 0xfffe, 0x4, 0x2, 0x2, 0x1, 0x3, 0x0, 0x1, 0x0, 0xffff, 0x1, 0xfffe, 0xffff, 0xffff, 0x0, 0x1, 0xffff, 0xffff, 0x1, 0x0, 0x0, 0xffff, 0x0, 0xffff, 0x1, 0x0, 0x0, 0xffff, 0xffff, 0xffff, 0x1, 0x0, 0xfffe, 0xfffe, 0x0, 0x4, 0xfffe, 0xffff, 0xfffe, 0x2, 0x0, 0x1, 0x0, 0x0, 0x3, 0x0, 0x0, 0x1, 0x0, 0x0, 0xfffe, 0xffff, 0x1, 0xffff, 0x1, 0xffff, 0x0, 0x2, 0x1, 0x2, 0x0, 0xfffe, 0x0, 0x2, 0x1, 0x2, 0x1, 0x2, 0xfffe, 0x1, 0x1, 0xffff, 0xffff, 0x0, 0xfffe, 0xffff, 0xfffe, 0xffff, 0x1, 0x0, 0x0, 0x0, 0x2, 0x2, 0x0, 0x0, 0xfffe, 0x1, 0xfffe, 0x1, 0x1, 0xffff, 0x1, 0x2, 0xffff, 0x2, 0x0, 0x0, 0x0, 0xfffe, 0x0, 0x1, 0xffff, 0x1, 0x1, 0xffff, 0xffff, 0x1, 0x2, 0x1, 0x3, 0x1, 0x2, 0xfffe, 0x1, 0x0, 0xffff, 0x0, 0xffff, 0x0, 0x0, 0xffff, 0xffff, 0x0, 0x0, 0x0, 0x0, 0x1, 0x0, 0x0, 0x2, 0x1, 0x0, 0xfffe, 0x1, 0xfffe, 0x1, 0x2, 0xfffe, 0x0, 0x2, 0xffff, 0x2, 0x0, 0x1, 0x1, 0xffff, 0xfffe, 0x0, 0x0, 0x0, 0x1, 0xffff, 0x0, 0x1, 0x0, 0x1, 0x1, 0xfffe, 0x0, 0xffff, 0x1, 0x2, 0xfffe, 0x1, 0x1, 0x1, 0xfffe, 0xffff, 0xfffe, 0xffff, 0x0, 0x1, 0xfffe, 0x1, 0xfffe, 0x1, 0xffff, 0xffff, 0x0, 0x1, 0xffff, 0x0, 0xffff, 0xfffe, 0xfffe, 0x1, 0x0, 0x2, 0x0, 0x0, 0x0, 0x1, 0x4, 0x0, 0x1, 0xffff, 0x0, 0x1, 0x0, 0x3, 0xfffe, 0x1, 0x2, 0x0, 0x1, 0xffff, 0x0, 0x2, 0xfffe, 0x0, 0x2, 0x3, 0x3, 0x1, 0x1, 0x0, 0xffff, 0x1, 0xffff, 0x0, 0x1, 0x1, 0x1, 0xfffe, 0x0, 0xffff, 0xfffe, 0x0
};

uint16_t count = 0;

uint8_t get_key(uint8_t* k)
{
	// Load key here
	return 0x00;
}

#if SS_VER == SS_VER_2_0
uint8_t get_pt(uint8_t cmd, uint8_t scmd, uint8_t len, uint8_t* pt)
#else
uint8_t get_pt(uint8_t* pt)
#endif

{ 
    int i;
    uint16_t b[256];
    uint16_t res[256] = {0,};
    
    for(i=0;i<256;i++){
        b[i] = 0xfffd;
    }
    trigger_high();
    karatsuba_simple(a,b,res);
    trigger_low();


	/**********************************
	* Start user-specific code here. */
	//16 hex bytes held in 'pt' were sent
	//from the computer. Store your response
	//back into 'pt', which will send 16 bytes
	//back to computer. Can ignore of course if
	//not needed
   
	/* End user-specific code here. *
	********************************/
	simpleserial_put('r', 16, pt);
	return 0x00;
}

uint8_t reset(uint8_t* x)
{
	// Reset key here if needed
	return 0x00;
}


int main(void)
{
    platform_init();
	init_uart();	
	trigger_setup();
	
 	/* Uncomment this to get a HELLO message for debug */
	/*
	putch('h');
	putch('e');
	putch('l');
	putch('l');
	putch('o');
	putch('\n');
	*/
		
	simpleserial_init();		
	simpleserial_addcmd('p', 16, get_pt);
#if SS_VER != SS_VER_2_0
	simpleserial_addcmd('k', 16, get_key);
	simpleserial_addcmd('x', 0, reset);
#endif
	while(1)
		simpleserial_get();
}
